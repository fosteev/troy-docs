# Combat — Боевая система

## Обзор

Бой в реальном времени. Игрок нажимает кнопки скиллов на экране, между скиллами персонаж автоматически бьёт автоатакой. Моб атакует по своим таймерам. Бой заканчивается когда HP одной из сторон достигает 0.

---

## Вход в бой

1. Игрок видит моба на карте (реальная геолокация)
2. Подходит на расстояние взаимодействия (радиус 50м)
3. Нажимает на моба → открывается экран боя
4. Бой начинается немедленно

---

## Ресурсные системы в бою

### Warrior — Rage (Ярость)

Воин входит в бой с **Rage = 0**. Ярость накапливается:

```
При автоатаке:        rage += 5 * (1 + SPI * 0.02)
При получении урона:  rage += damage_taken * 0.15 * (1 + SPI * 0.02)
```

- Максимум: 100 (фиксированный)
- Скиллы тратят ярость (15–40 за скилл)
- Вне боя ярость **сбрасывается в 0**
- В начале боя воин вынужден бить автоатакой, пока не накопит ярость на первый скилл

**Геймплей**: воин разгоняется по ходу боя. Чем дольше бой — тем чаще он использует скиллы. Получение урона — не только минус HP, но и плюс ярости.

### Mage — Mana (Мана)

Маг входит в бой с **полной маной**. Мана тратится на скиллы и восстанавливается со временем:

```
Max_Mana = base_mana + INT * 8

Регенерация в бою:  max_mana * 0.01 * (1 + SPI * 0.02) per second
```

- Скиллы тратят ману (15–45 за скилл)
- Если мана кончилась — только автоатака

**Геймплей**: маг мощен в начале боя, но должен экономить ману. Spirit помогает поддерживать ману в долгих боях. Выбор: выложить весь урон быстро или растянуть на дистанцию.

---

## Автоатака

Персонаж автоматически бьёт между скиллами с интервалом, зависящим от Attack Speed.

```
attack_interval = 1 / Attack_Speed (сек)
Attack_Speed = base_as * (1 + AGI * 0.01)
```

| Класс | base_as | Интервал (AGI=0) | Интервал (AGI=30) |
|---|---|---|---|
| Warrior | 0.8 | 1.25 сек | 0.96 сек |
| Mage | 0.5 | 2.0 сек | 1.54 сек |

### Тип автоатаки

| Класс | Тип урона | Формула | Доп. эффект |
|---|---|---|---|
| Warrior | Physical | `base_weapon_dmg + STR * 0.8` | +rage генерация |
| Mage | Magical | `base_spell_dmg + INT * 0.5` | — |

Автоатака мага проходит через Magic Resist, воина — через Armor.

Автоатака воина **генерирует Rage** — это основной способ накопления ресурса в начале боя.

---

## Скиллы

### Параметры скилла

| Параметр | Описание |
|---|---|
| `cast_time` | Время произнесения (сек). 0 = инстант |
| `cooldown` | Перезарядка после использования (сек) |
| `resource_cost` | Стоимость ресурса (Rage для Warrior, Mana для Mage) |
| `damage_type` | `physical` или `magical` |
| `base_damage` | Базовый урон (фиксированный) |
| `scaling_stat` | От какого атрибута скейлится (STR / INT) |
| `scaling_ratio` | Коэффициент (напр. 1.2 = 120% от атрибута) |
| `effect` | Доп. эффект: stun, slow, heal, dot, buff, absorb |
| `effect_duration` | Длительность эффекта (сек) |

### Условия использования скилла

```
1. Скилл не на кулдауне
2. Достаточно ресурса (rage >= cost ИЛИ mana >= cost)
3. Персонаж не в стане
```

Если ресурса не хватает — кнопка скилла неактивна (серая).

### Влияние Agility на скиллы

```
actual_cast_time = base_cast_time / (1 + AGI * 0.01)
actual_cooldown  = base_cooldown / (1 + AGI * 0.01)
```

Примеры:
- Fireball (cast 1.5s) при AGI=20: `1.5 / 1.2 = 1.25s`
- Heavy Strike (CD 3s) при AGI=30: `3 / 1.3 = 2.3s`

### Механика каста

1. Игрок нажимает скилл
2. Списывается ресурс (rage или mana)
3. Если `cast_time > 0` — начинается каст-бар
4. Во время каста автоатака **не бьёт** (воин не генерит ярость автоатакой!)
5. После каста — применяется урон/эффект
6. Скилл уходит на кулдаун
7. Автоатака возобновляется

Инстант-скиллы (`cast_time = 0`) не прерывают автоатаку — можно нажать между ударами.

### Прерывание каста (Interrupt)

- Если персонаж получает `stun` во время каста, каст **срывается**
- Урон/эффект не применяются
- Потраченный ресурс **не возвращается**
- На скилл ставится штрафной кулдаун `50%` от его обычного CD
- Инстант-скиллы (`cast_time = 0`) не могут быть прерваны

---

## Полная формула урона

### Шаг 1: Raw Damage

```
// Скилл
raw = skill.base_damage + character[skill.scaling_stat] * skill.scaling_ratio

// Автоатака (зависит от класса)
// Warrior: raw = base_weapon_dmg + STR * 0.8   (physical)
// Mage:    raw = base_spell_dmg  + INT * 0.5   (magical)
```

### Шаг 2: Crit

```
roll = random(0, 100)
if roll < character.crit_chance:
    raw = raw * character.crit_multiplier  // default: 2.0
```

### Шаг 3: Defense

```
if damage_type == "physical":
    defense = target.armor
else:
    defense = target.magic_resist

reduction = defense / (defense + 100)
```

### Шаг 4: Dodge

```
roll = random(0, 100)
if roll < target.dodge:
    final = 0  // MISS
else:
    final = raw * (1 - reduction)
```

### Шаг 5: Apply + Resource

```
target.hp -= final
if target.hp <= 0:
    combat ends, attacker wins

if attacker.class == "Warrior" and action_type == "auto_attack":
    attacker.rage += 5 * (1 + attacker.SPI * 0.02)

if target.class == "Warrior" and final > 0: // любой источник: автоатака, скилл, DoT
    target.rage += final * 0.15 * (1 + target.SPI * 0.02)

if attacker.class == "Warrior":
    attacker.rage = clamp(attacker.rage, 0, 100)
if target.class == "Warrior":
    target.rage = clamp(target.rage, 0, 100)
```

---

## Поведение моба в бою

Моб атакует автоматически по таймеру (свой attack_speed). У мобов тоже могут быть скиллы (простые, 1-2 штуки). Моб использует скиллы по кулдауну, без AI — просто по таймеру.

```
mob_auto_interval = 1 / mob.attack_speed
mob_skill_usage: каждые cooldown секунд
```

Мобы не имеют ресурсной системы — их скиллы ограничены только кулдаунами.

`Dodge` у обычных мобов = 0%. Уклонение допускается только у специальных мобов/элит и должно быть явно задано в их статах.

---

## Эффекты (Effects)

| Эффект | Описание |
|---|---|
| **stun** | Цель не может атаковать и кастовать на duration сек |
| **slow** | Уменьшает attack_speed цели на 30% на duration сек |
| **dot** (damage over time) | Урон каждую секунду на duration сек |
| **buff** | Увеличивает указанную характеристику на duration сек |
| **absorb** | Создаёт щит, поглощающий N урона |
| **heal** | Восстанавливает HP |

---

## Конец боя

### Победа (моб убит)

- Игрок получает XP (зависит от уровня моба)
- Генерируется лут по дроп-таблице моба

### Поражение (игрок убит)

- Нет permadeath
- Персонаж остаётся в текущей геопозиции (без телепорта/респавна в другую точку)
- Персонаж выводится из строя на 60 секунд (`incapacitated`)
- Штраф XP: `-5%` от прогресса текущего уровня (уровень не понижается)
- Повторный вход в бой блокируется на время `incapacitated` (60 секунд)

### Побег

- Побег разрешён всем классам
- Механика: удержание кнопки `Побег` в течение 3 секунд (channel)
- Любой полученный урон или `stun` во время channel прерывает побег
- Успешный побег завершает бой без XP/лута, моб возвращается к полному HP

---

## Инициализация боя

Каждый бой начинается с максимальных ресурсов:

```
currentHp   = maxHp
currentMana = maxMana   (Mage)
currentRage = 0         (Warrior)
```

Регенерация вне боя не нужна — состояние полностью сбрасывается при входе в бой.

---

## Открытый вопрос

- [ ] Баланс: тестирование формул на разных уровнях (TTK, частота скиллов, цена ошибки при поражении)
