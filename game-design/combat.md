# Combat — Боевая система

## Обзор

Бой в реальном времени. Игрок нажимает кнопки скиллов на экране, между скиллами персонаж автоматически бьёт автоатакой. Моб атакует по своим таймерам. Бой заканчивается когда HP одной из сторон достигает 0.

---

## Вход в бой

1. Игрок видит моба на карте (реальная геолокация)
2. Подходит на расстояние взаимодействия (радиус TBD, ~50м)
3. Нажимает на моба → открывается экран боя
4. Бой начинается немедленно

---

## Автоатака

Персонаж автоматически бьёт между скиллами с интервалом, зависящим от Attack Speed.

```
attack_interval = 1 / Attack_Speed (сек)
Attack_Speed = base_as * (1 + AGI * 0.01)
```

| Класс | base_as | Интервал (AGI=0) | Интервал (AGI=30) |
|---|---|---|---|
| Warrior | 0.8 | 1.25 сек | 0.96 сек |
| Mage | 0.5 | 2.0 сек | 1.54 сек |

### Тип автоатаки

| Класс | Тип урона | Формула |
|---|---|---|
| Warrior | Physical | `base_weapon_dmg + STR * 0.8` |
| Mage | Magical | `base_spell_dmg + INT * 0.5` |

Автоатака мага проходит через Magic Resist, воина — через Armor. Это принципиально: маг не бесполезен против бронированных мобов.

---

## Скиллы

### Параметры скилла

| Параметр | Описание |
|---|---|
| `cast_time` | Время произнесения (сек). 0 = инстант |
| `cooldown` | Перезарядка после использования (сек) |
| `mana_cost` | Стоимость маны |
| `damage_type` | `physical` или `magical` |
| `base_damage` | Базовый урон (фиксированный) |
| `scaling_stat` | От какого атрибута скейлится (STR / INT) |
| `scaling_ratio` | Коэффициент (напр. 1.2 = 120% от атрибута) |
| `effect` | Доп. эффект: stun, slow, heal, dot, buff, absorb |
| `effect_duration` | Длительность эффекта (сек) |

### Влияние Agility на скиллы

```
actual_cast_time = base_cast_time / (1 + AGI * 0.01)
actual_cooldown  = base_cooldown / (1 + AGI * 0.01)
```

Примеры:
- Fireball (cast 1.5s) при AGI=20: `1.5 / 1.2 = 1.25s`
- Heavy Strike (CD 3s) при AGI=30: `3 / 1.3 = 2.3s`

### Механика каста

1. Игрок нажимает скилл
2. Если `cast_time > 0` — начинается каст-бар
3. Во время каста автоатака **не бьёт**
4. После каста — применяется урон/эффект
5. Скилл уходит на кулдаун
6. Автоатака возобновляется

Инстант-скиллы (`cast_time = 0`) не прерывают автоатаку — можно нажать между ударами.

---

## Полная формула урона

### Шаг 1: Raw Damage

```
// Скилл
raw = skill.base_damage + character[skill.scaling_stat] * skill.scaling_ratio

// Автоатака
raw = base_weapon_dmg + character[scaling_stat] * auto_ratio
```

### Шаг 2: Crit

```
roll = random(0, 100)
if roll < character.crit_chance:
    raw = raw * character.crit_multiplier  // default: 2.0
```

### Шаг 3: Defense

```
if damage_type == "physical":
    defense = target.armor
else:
    defense = target.magic_resist

reduction = defense / (defense + 100)
```

### Шаг 4: Dodge

```
roll = random(0, 100)
if roll < target.dodge:
    final = 0  // MISS
else:
    final = raw * (1 - reduction)
```

### Шаг 5: Apply

```
target.hp -= final
if target.hp <= 0:
    combat ends, attacker wins
```

---

## Поведение моба в бою

Моб атакует автоматически по таймеру (свой attack_speed). У мобов тоже могут быть скиллы (простые, 1-2 штуки). Моб использует скиллы по кулдауну, без AI — просто по таймеру.

```
mob_auto_interval = 1 / mob.attack_speed
mob_skill_usage: каждые cooldown секунд, если хватает маны
```

---

## Эффекты (Effects)

| Эффект | Описание |
|---|---|
| **stun** | Цель не может атаковать и кастовать на duration сек |
| **slow** | Уменьшает attack_speed цели на 30% на duration сек |
| **dot** (damage over time) | Урон каждую секунду на duration сек |
| **buff** | Увеличивает указанную характеристику на duration сек |
| **absorb** | Создаёт щит, поглощающий N урона |
| **heal** | Восстанавливает HP |

---

## Конец боя

### Победа (моб убит)

- Игрок получает XP (зависит от уровня моба)
- Генерируется лут по дроп-таблице моба
- HP/Mana **не восстанавливаются** полностью (TBD: частичное восстановление?)

### Поражение (игрок убит)

- Нет permadeath
- Штраф TBD: потеря части золота? Респавн на месте? Кулдаун на бой?

### Побег

- TBD: Можно ли убежать из боя? Если да — условия?

---

## Регенерация

Вне боя:
```
hp_regen = max_hp * 0.02 per second (2% в секунду)
mana_regen = max_mana * 0.03 per second (3% в секунду)
```

В бою:
```
hp_regen = 0 (только через скиллы/зелья)
mana_regen = max_mana * 0.01 per second (1% в секунду)
```

---

## TODO

- [ ] Определить поведение при поражении (штрафы)
- [ ] Определить механику побега из боя
- [ ] Определить частичное восстановление HP/Mana после победы
- [ ] Прервать каст при стане? (interrupt механика)
- [ ] Может ли моб додж-ить атаки игрока?
- [ ] Баланс: тестирование формул на разных уровнях
